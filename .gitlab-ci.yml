stages:
  - build
  - deploy

variables:
  GCP_PROJECT: "myproj"
  GCP_REGION: "europe-west1"
  ARTIFACT_REGISTRY_REPO: "heather"
  BACKEND_APP_NAME: "heather-backend"
  # GitLab runner memory settings
  KUBERNETES_MEMORY_REQUEST: 2Gi
  KUBERNETES_MEMORY_LIMIT: 4Gi

build-backend:
  stage: build
  image: gradle:9-jdk21@sha256:db12d4789367d4676ef3d8aa672685e0e451705776b53f7d81c953fba3b1d55b
  before_script:
    # Install gcloud SDK for registry authentication
    - apt-get update && apt-get install -y curl
    - curl -sSL https://sdk.cloud.google.com | bash
    - export PATH=$HOME/google-cloud-sdk/bin:$PATH
    # Authenticate with GCP
    - echo $GCP_SERVICE_KEY | base64 -d > /tmp/gcp-key.json
    - export GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp-key.json
    - gcloud auth activate-service-account --key-file=$GOOGLE_APPLICATION_CREDENTIALS --project=$GCP_PROJECT
    # Configure Jib to use gcloud credentials
    - gcloud auth configure-docker $GCP_REGION-docker.pkg.dev --quiet
  script:
    - cd backend
    # Run tests and checks
    - ./gradlew check --no-daemon
    # Build and push image using Jib (no Docker daemon required)
    - ./gradlew jib --no-daemon
  artifacts:
    reports:
      junit: backend/build/test-results/test/**/TEST-*.xml
    paths:
      - backend/build/reports/
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

deploy-backend:
  stage: deploy
  image: google/cloud-sdk:alpine@sha256:69857eb8768d2eaa0d84b84098d54a590c5bc3080ccdb51034a3756c839762c2
  before_script:
    - echo $GCP_SERVICE_KEY | base64 -d > /tmp/gcp-key.json
    - gcloud auth activate-service-account --key-file=/tmp/gcp-key.json --project=$GCP_PROJECT
  script:
    - |
      gcloud run deploy $BACKEND_APP_NAME \
        --image $GCP_REGION-docker.pkg.dev/$GCP_PROJECT/$ARTIFACT_REGISTRY_REPO/$BACKEND_APP_NAME:$CI_COMMIT_SHA \
        --region $GCP_REGION \
        --platform managed \
        --allow-unauthenticated \
        --port 8080 \
        --memory 1Gi \
        --cpu 1 \
        --min-instances 0 \
        --max-instances 1 \
        --timeout 300 \
        --set-env-vars SPRING_PROFILES_ACTIVE=cloud
    - echo "Backend deployment completed!"
    - gcloud run services describe $BACKEND_APP_NAME --region=$GCP_REGION --format='value(status.url)'
  needs:
    - job: build-backend
      optional: true
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

  environment:
    name: production-backend
    url: https://$BACKEND_APP_NAME-$CI_COMMIT_SHORT_SHA-ew.a.run.app

deploy-frontend:
  stage: deploy
  image: node:24-alpine@sha256:b0d33ed19a912e1a18ceb83e139815233cd49c123fe025e67a7c506c93e3f728
  variables:
    BUCKET_NAME: "heather-frontend"
  before_script:
    # Install gcloud CLI for deployment
    - apk add --no-cache curl bash python3
    - curl -sSL https://sdk.cloud.google.com | bash
    - export PATH=$HOME/google-cloud-sdk/bin:$PATH
    # Authenticate with GCP using service account
    - echo $GCP_SERVICE_KEY | base64 -d > /tmp/gcp-key.json
    - gcloud auth activate-service-account --key-file=/tmp/gcp-key.json --project=$GCP_PROJECT
  script:
    - cd frontend
    # Get the actual backend URL from the deployed service
    - export VITE_API_BASE_URL=$(gcloud run services describe $BACKEND_APP_NAME --region=$GCP_REGION --format='value(status.url)')
    # Install dependencies
    - npm ci
    # Build the application (skip linting in CI for now)
    - npm run build:only
    # Upload built files to bucket with proper metadata
    - gsutil -m rsync -r -d dist/ gs://$BUCKET_NAME
    # Set cache control for static assets (handle missing file types gracefully)
    - gsutil -m setmeta -h "Cache-Control:public, max-age=31536000" gs://$BUCKET_NAME/**/*.js || true
    - gsutil -m setmeta -h "Cache-Control:public, max-age=31536000" gs://$BUCKET_NAME/**/*.css || true
    - gsutil -m setmeta -h "Cache-Control:public, max-age=31536000" gs://$BUCKET_NAME/**/*.woff || true
    - gsutil -m setmeta -h "Cache-Control:public, max-age=31536000" gs://$BUCKET_NAME/**/*.woff2 || true
    - gsutil -m setmeta -h "Cache-Control:public, max-age=31536000" gs://$BUCKET_NAME/**/*.ttf || true
    # Set cache control for HTML files
    - gsutil -m setmeta -h "Cache-Control:public, max-age=0, must-revalidate" gs://$BUCKET_NAME/**/*.html || true
    - gsutil -m setmeta -h "Cache-Control:public, max-age=0, must-revalidate" gs://$BUCKET_NAME/index.html
  artifacts:
    paths:
      - frontend/dist/
  needs:
    - job: deploy-backend
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  environment:
    name: production-frontend
    url: https://storage.googleapis.com/$BUCKET_NAME/index.html

build-backend-mr:
  stage: build
  image: gradle:9-jdk21@sha256:db12d4789367d4676ef3d8aa672685e0e451705776b53f7d81c953fba3b1d55b
  script:
    - cd backend
    - ./gradlew check build --no-daemon
  artifacts:
    reports:
      junit: backend/build/test-results/test/**/TEST-*.xml
    paths:
      - backend/build/reports/
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

build-frontend-mr:
  stage: build
  image: node:24-alpine@sha256:b0d33ed19a912e1a18ceb83e139815233cd49c123fe025e67a7c506c93e3f728
  script:
    - cd frontend
    - npm ci
    - npm run validate
  artifacts:
    paths:
      - frontend/dist/
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
